imports:
- path: instance.jinja
- path: cluster.jinja
- path: k8s-type.py
- path: hippo.jinja
- path: lion.jinja
- path: narwhal.jinja
- path: mongoose.jinja

resources:
- name: default-vpc
  type: remove-default-vpc.jinja

##Create new VPC
- name: local-vpc
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: primary-local
  type: compute.v1.subnetwork
  properties:
    network: $(ref.local-vpc.selfLink) 
    ipCidrRange: 192.168.0.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pods
        ipCidrRange: 10.0.0.0/9
      - rangeName: pods1
        ipCidrRange: 172.16.0.0/23
      - rangeName: services1
        ipCidrRange: 172.16.16.0/20
      - rangeName: services2
        ipCidrRange: 172.16.2.0/23
      - rangeName: services3
        ipCidrRange: 172.16.32.0/20
- name: allow-internal-local
  type: compute.v1.firewall
  properties:
    network: $(ref.local-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    - 172.16.0.0/16
    - 10.0.0.0/8
    allowed:
    - IPProtocol: all

- name: another-vpc
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: not-as-local
  type: compute.v1.subnetwork
  properties:
    network: $(ref.another-vpc.selfLink) 
    ipCidrRange: 192.168.56.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pods
        ipCidrRange: 10.128.0.0/9
      - rangeName: services1
        ipCidrRange: 172.16.128.0/23
      - rangeName: services2
        ipCidrRange: 172.16.130.0/23
      - rangeName: services3
        ipCidrRange: 172.16.144.0/20
      - rangeName: services4
        ipCidrRange: 172.16.160.0/20
- name: allow-internal-another
  type: compute.v1.firewall
  properties:
    network: $(ref.another-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    - 172.16.0.0/16
    - 10.0.0.0/8
    allowed:
    - IPProtocol: all
- name: bastion-ssh
  type: compute.v1.firewall
  properties:
    network: $(ref.local-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges: 
    - 0.0.0.0/0
    targetTags:
    - bastion
    allowed:
    - IPProtocol: TCP
      ports: 
      - 22

- name: bastionip
  type: compute.v1.addresses
  properties:
    addressType: EXTERNAL
    region: us-central1

- name: addPeering
  type: peering.jinja
  metadata:
    dependsOn:
    - primary-local
    - not-as-local
  properties:
    net1: local-vpc
    net2: another-vpc

- name: instance1
  type: instance.jinja
  metadata:
    dependsOn:
    - addPeering
  properties:
    name: bastion
    region: us-central1
    zone: us-central1-c
    networkInterfaces:
    - network: local-vpc
      subnetwork: primary-local
      natIP: $(ref.bastionip.address)
    tags:
    - bastion
    autoDelete: true
    osLogin: enabled
    metadata:
    - key: block-project-ssh-keys
      value: "true"

- name: cluster1
  type: cluster.jinja
  metadata:
    dependsOn:
    - addPeering
  properties:
    name: standard-cluster-1
    location: us-central1-a
    network: local-vpc
    subnetwork: primary-local
    nodePools:
    - name: default

- name: cluster2
  type: cluster.jinja
  metadata:
    dependsOn:
    - addPeering
  properties:
    name: hippo
    location: us-central1
    network: local-vpc
    subnetwork: primary-local
    vpc-native: true
    pod-cidr: pods1
    service-cidr: services2
    private-cluster: true
    enablePrivateEndpoint: false
    hosts:
    - host-name: bastion
      host-cidr: $(ref.bastionip.address)/32
    master-cidr: 172.16.48.0/28
    nodePools:
    - name: default
      initialNodeCount: 1
      machineType: n1-standard-2
- name: k8s-hippo
  type: k8s-type.py
  properties:
    cluster: hippo
    endpoint: $(ref.hippo.endpoint)
- name: hippo-workloads
  type: hippo.jinja
  metadata:
    dependsOn:
    - hippo-v1
    - hippo-v1-apps

- name: cluster3
  type: cluster.jinja
  metadata:
    dependsOn:
    - addPering
  properties:
    name: lion
    location: us-central1
    network: local-vpc
    subnetwork: primary-local
    vpc-native: true
    pod-cidr: pods
    service-cidr: services1
    nodePools:
    - name: default
      initialNodeCount: 1
      minNodeCount: 3
      maxNodeCount: 9
    - name: big-pods
      initialNodeCount: 1
      machineType: n1-standard-2
- name: k8s-lion
  type: k8s-type.py
  properties:
    cluster: lion
    endpoint: $(ref.lion.endpoint)
- name: lion-worlkloads
  type: lion.jinja
  properties:
    cluster: lion
  metadata:
    dependsOn:
    - lion-v1
    - lion-v1-apps
    - lion-v1beta1-extensions

- name: cluster4
  type: cluster.jinja
  metadata:
    dependsOn:
    - addPeering
  properties:
    name: narwhal
    location: us-central1-a
    network: another-vpc
    subnetwork: not-as-local
    networkPolicy: true
    vpc-native: true
    pod-cidr: pods
    service-cidr: services1
    httpLB: true
    nodePools:
    - name: unicorn-of-the-sea
- name: k8s-narwhal
  type: k8s-type.py
  properties:
    cluster: narwhal
    endpoint: $(ref.narwhal.endpoint)
- name: narwhal-workloads
  type: narwhal.jinja
  metadata:
    dependsOn:
    - narwhal-v1
    - narwhal-v1-apps

- name: cluster5
  type: cluster.jinja
  metadata:
    dependsOn:
    - addPeering
  properties:
    name: mongoose
    location: us-central1-a
    network: another-vpc
    subnetwork: not-as-local
    vpc-native: true
    pod-cidr: pods1
    service-cidr: service2
    private-cluster: true
    enablePrivateEndpoint: true
    master-cidr: 172.16.176.0/28
    hosts:
    - host-name: internal-network
      host-cidr: 192.168.0.0/16
    httpLB: true
    nodePools:
    - name: weird-mammal
      initialNodeCount: 4
      machineType: n1-highcpu-4
      minNodeCount: 1
      maxNodeCount: 4
- name: k8s-mongoose
  type: k8s-type.py
  properties:
    cluster: mongoose
    endpoint: $(ref.mongoose.endpoint)
- name: mongoose-workloads
  type: mongoose.jinja
  metadata:
    dependsOn:
    - mongoose-v1
    - mongoose-v1-apps
