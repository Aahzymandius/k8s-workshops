imports:
- path: peering.jinja
- path: remove-default-vpc.jinja

resources:
## Comment this section out if you wish to keep your default VPC
- name: default-vpc
  type: remove-default-vpc.jinja

- name: local-vpc
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: primary-local
  type: compute.v1.subnetwork
  properties:
    network: $(ref.local-vpc.selfLink) 
    ipCidrRange: 192.168.0.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pods
        ipCidrRange: 10.0.0.0/9
      - rangeName: pods1
        ipCidrRange: 172.16.0.0/23
      - rangeName: services1
        ipCidrRange: 172.16.16.0/20
      - rangeName: services2
        ipCidrRange: 172.16.2.0/23
      - rangeName: services3
        ipCidrRange: 172.16.32.0/20
- name: allow-internal-local
  type: compute.v1.firewall
  properties:
    network: $(ref.local-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    - 172.16.0.0/16
    - 10.0.0.0/8
    allowed:
    - IPProtocol: all
- name: bastion-ssh
  type: compute.v1.firewall
  properties:
    network: $(ref.local-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges: 
    - 0.0.0.0/0
    targetTags:
    - bastion
    allowed:
    - IPProtocol: TCP
      ports: 
      - 22

- name: another-vpc
  type: compute.v1.network
  properties: 
    autoCreateSubnetworks: false
- name: not-as-local
  type: compute.v1.subnetwork
  properties:
    network: $(ref.another-vpc.selfLink) 
    ipCidrRange: 192.168.56.0/24
    region: us-central1
    secondaryIpRanges:
      - rangeName: pods
        ipCidrRange: 10.128.0.0/9
      - rangeName: services1
        ipCidrRange: 172.16.128.0/23
      - rangeName: services2
        ipCidrRange: 172.16.130.0/23
      - rangeName: services3
        ipCidrRange: 172.16.144.0/20
      - rangeName: services4
        ipCidrRange: 172.16.160.0/20
- name: allow-internal-another
  type: compute.v1.firewall
  properties:
    network: $(ref.another-vpc.selfLink)
    priority: 1000
    direction: INGRESS
    sourceRanges:
    - 192.168.0.0/16
    - 172.16.0.0/16
    - 10.0.0.0/8
    allowed:
    - IPProtocol: all

- name: bastionip
  type: compute.v1.addresses
  properties:
    addressType: EXTERNAL
    region: us-central1

- name: addPeering
  type: peering.jinja
  metadata:
    dependsOn:
    - primary-local
    - not-as-local
  properties:
    net1: local-vpc
    net2: another-vpc
